<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETL Pipeline - Demo Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Custom styles */
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .status-completed { background-color: #10b981; }
        .status-processing { background-color: #f59e0b; }
        .status-failed { background-color: #ef4444; }
        .status-pending { background-color: #6b7280; }
        .status-skipped { background-color: #8b5cf6; }
        .markdown-content {
            font-family: ui-monospace, monospace;
            white-space: pre-wrap;
            background: #1e293b;
            color: #e2e8f0;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
                        <i class="fas fa-database text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">ETL Pipeline</h1>
                        <p class="text-sm text-gray-500">Document Processing Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="connection-status" class="flex items-center text-sm">
                        <span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>
                        Checking...
                    </span>
                    <button onclick="refreshAll()" class="p-2 text-gray-500 hover:text-blue-500 transition">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Stats Bar -->
    <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div id="stat-documents" class="text-2xl font-bold text-blue-600">-</div>
                    <div class="text-sm text-gray-500">Documents</div>
                </div>
                <div class="text-center">
                    <div id="stat-chunks" class="text-2xl font-bold text-green-600">-</div>
                    <div class="text-sm text-gray-500">Chunks</div>
                </div>
                <div class="text-center">
                    <div id="stat-completed" class="text-2xl font-bold text-emerald-600">-</div>
                    <div class="text-sm text-gray-500">Completed</div>
                </div>
                <div class="text-center">
                    <div id="stat-failed" class="text-2xl font-bold text-red-600">-</div>
                    <div class="text-sm text-gray-500">Failed</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-white border-b sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4">
            <nav class="flex space-x-8">
                <button onclick="switchTab('documents')" id="tab-documents" class="tab-btn py-4 px-1 text-sm font-medium tab-active">
                    <i class="fas fa-file-pdf mr-2"></i>Documents
                </button>
                <button onclick="switchTab('chunks')" id="tab-chunks" class="tab-btn py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-puzzle-piece mr-2"></i>Chunks
                </button>
                <button onclick="switchTab('images')" id="tab-images" class="tab-btn py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-images mr-2"></i>Images
                </button>
                <button onclick="switchTab('search')" id="tab-search" class="tab-btn py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-search mr-2"></i>Search
                </button>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Documents Tab -->
        <div id="panel-documents" class="tab-panel">
            <!-- Upload Section -->
            <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">Upload Document</h2>
                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <label class="flex items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 transition" id="upload-area">
                            <div class="text-center">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-500">Drop PDF here or click to upload</p>
                                <p id="selected-file" class="text-sm text-blue-500 mt-1 hidden"></p>
                            </div>
                            <input type="file" id="file-input" accept=".pdf" class="hidden">
                        </label>
                    </div>
                    <div class="flex flex-col space-y-2">
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="force-upload" class="mr-2">
                            Force reprocess
                        </label>
                        <button onclick="uploadDocument()" id="upload-btn" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition" disabled>
                            <i class="fas fa-upload mr-2"></i>Upload
                        </button>
                    </div>
                </div>
                <div id="upload-progress" class="mt-4 hidden">
                    <div class="flex items-center">
                        <div class="animate-spin mr-3">
                            <i class="fas fa-spinner text-blue-500"></i>
                        </div>
                        <span class="text-sm text-gray-600">Processing document...</span>
                    </div>
                </div>
            </div>

            <!-- Documents List -->
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-4 border-b flex items-center justify-between">
                    <h2 class="text-lg font-semibold">Documents</h2>
                    <select id="status-filter" onchange="loadDocuments()" class="text-sm border rounded-lg px-3 py-1">
                        <option value="">All Status</option>
                        <option value="completed">Completed</option>
                        <option value="processing">Processing</option>
                        <option value="failed">Failed</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div id="documents-list" class="divide-y">
                    <!-- Documents will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Chunks Tab -->
        <div id="panel-chunks" class="tab-panel hidden">
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-4 border-b">
                    <div class="flex items-center space-x-4">
                        <select id="chunk-document-filter" onchange="loadChunksForDocument()" class="flex-1 border rounded-lg px-3 py-2">
                            <option value="">Select a document...</option>
                        </select>
                        <span id="chunk-count" class="text-sm text-gray-500"></span>
                    </div>
                </div>
                <div id="chunks-list" class="divide-y max-h-[600px] overflow-y-auto">
                    <div class="p-8 text-center text-gray-500">
                        <i class="fas fa-puzzle-piece text-4xl mb-3"></i>
                        <p>Select a document to view its chunks</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Images Tab -->
        <div id="panel-images" class="tab-panel hidden">
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-4 border-b">
                    <select id="image-document-filter" onchange="loadImagesForDocument()" class="w-full border rounded-lg px-3 py-2">
                        <option value="">Select a document...</option>
                    </select>
                </div>
                <div id="images-grid" class="p-4">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-images text-4xl mb-3"></i>
                        <p>Select a document to view its images</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Tab -->
        <div id="panel-search" class="tab-panel hidden">
            <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Search Query</label>
                        <input type="text" id="search-query" placeholder="Enter your search query..." class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Search Mode</label>
                            <select id="search-mode" class="w-full border rounded-lg px-3 py-2">
                                <option value="hybrid">Hybrid (Recommended)</option>
                                <option value="vector">Vector (Semantic)</option>
                                <option value="keyword">Keyword (BM25)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Title Filter</label>
                            <input type="text" id="search-title-filter" placeholder="Optional..." class="w-full border rounded-lg px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Limit</label>
                            <input type="number" id="search-limit" value="10" min="1" max="50" class="w-full border rounded-lg px-3 py-2">
                        </div>
                    </div>
                    <button onclick="performSearch()" class="w-full py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                        <i class="fas fa-search mr-2"></i>Search
                    </button>
                </div>
            </div>
            <div id="search-results" class="space-y-4">
                <!-- Search results will appear here -->
            </div>
        </div>
    </main>

    <!-- Document Detail Modal -->
    <div id="document-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b flex items-center justify-between">
                <h3 id="modal-title" class="text-lg font-semibold">Document Details</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modal-content" class="flex-1 overflow-y-auto p-4">
                <!-- Modal content -->
            </div>
            <div id="modal-actions" class="p-4 border-t flex justify-end space-x-3">
                <!-- Modal actions -->
            </div>
        </div>
    </div>

    <!-- Confirm Dialog -->
    <div id="confirm-dialog" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
            <div class="text-center">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold mb-2">Confirm Delete</h3>
                <p id="confirm-message" class="text-gray-600 mb-6">Are you sure you want to delete this item?</p>
                <div class="flex space-x-3">
                    <button onclick="closeConfirm()" class="flex-1 py-2 border rounded-lg hover:bg-gray-50 transition">Cancel</button>
                    <button onclick="confirmAction()" class="flex-1 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 z-50 hidden">
        <div class="bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-3">
            <i id="toast-icon" class="fas fa-check-circle text-green-400"></i>
            <span id="toast-message">Success!</span>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8000/api';
        let currentTab = 'documents';
        let confirmCallback = null;
        let documentsCache = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkConnection();
            loadStats();
            loadDocuments();
            setupFileUpload();
        });

        // Connection check
        async function checkConnection() {
            const statusEl = document.getElementById('connection-status');
            try {
                const res = await fetch('http://localhost:8000/health');
                if (res.ok) {
                    statusEl.innerHTML = '<span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>Connected';
                    statusEl.className = 'flex items-center text-sm text-green-600';
                } else {
                    throw new Error('Not healthy');
                }
            } catch (e) {
                statusEl.innerHTML = '<span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>Disconnected';
                statusEl.className = 'flex items-center text-sm text-red-600';
            }
        }

        // Load stats
        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/stats`);
                const stats = await res.json();
                document.getElementById('stat-documents').textContent = stats.total_documents;
                document.getElementById('stat-chunks').textContent = stats.total_chunks.toLocaleString();
                document.getElementById('stat-completed').textContent = stats.by_status.completed || 0;
                document.getElementById('stat-failed').textContent = stats.by_status.failed || 0;
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }

        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('text-gray-500');
            });
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`tab-${tab}`).classList.remove('text-gray-500');

            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.add('hidden'));
            document.getElementById(`panel-${tab}`).classList.remove('hidden');

            // Load data for tab
            if (tab === 'chunks' || tab === 'images') {
                populateDocumentDropdowns();
            }
        }

        // File upload setup
        function setupFileUpload() {
            const fileInput = document.getElementById('file-input');
            const uploadArea = document.getElementById('upload-area');
            const uploadBtn = document.getElementById('upload-btn');
            const selectedFile = document.getElementById('selected-file');

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    selectedFile.textContent = file.name;
                    selectedFile.classList.remove('hidden');
                    uploadBtn.disabled = false;
                }
            });

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-blue-400', 'bg-blue-50');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    const file = e.dataTransfer.files[0];
                    selectedFile.textContent = file.name;
                    selectedFile.classList.remove('hidden');
                    uploadBtn.disabled = false;
                }
            });
        }

        // Upload document
        async function uploadDocument() {
            const fileInput = document.getElementById('file-input');
            const force = document.getElementById('force-upload').checked;
            const progressEl = document.getElementById('upload-progress');
            const uploadBtn = document.getElementById('upload-btn');

            if (!fileInput.files.length) return;

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            progressEl.classList.remove('hidden');
            uploadBtn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/documents/upload?force=${force}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (res.ok) {
                    showToast(data.message, data.status === 'completed' ? 'success' : 'info');
                    loadDocuments();
                    loadStats();
                    fileInput.value = '';
                    document.getElementById('selected-file').classList.add('hidden');
                } else {
                    showToast(data.detail || 'Upload failed', 'error');
                }
            } catch (e) {
                showToast('Upload failed: ' + e.message, 'error');
            } finally {
                progressEl.classList.add('hidden');
                uploadBtn.disabled = true;
            }
        }

        // Load documents
        async function loadDocuments() {
            const status = document.getElementById('status-filter').value;
            const listEl = document.getElementById('documents-list');

            listEl.innerHTML = '<div class="p-4"><div class="skeleton h-16 rounded"></div></div>'.repeat(3);

            try {
                const url = status ? `${API_BASE}/documents?status=${status}` : `${API_BASE}/documents`;
                const res = await fetch(url);
                const documents = await res.json();
                documentsCache = documents;

                if (documents.length === 0) {
                    listEl.innerHTML = `
                        <div class="p-8 text-center text-gray-500">
                            <i class="fas fa-folder-open text-4xl mb-3"></i>
                            <p>No documents found</p>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = documents.map(doc => `
                    <div class="p-4 hover:bg-gray-50 transition fade-in">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-file-pdf text-red-500"></i>
                                </div>
                                <div>
                                    <h3 class="font-medium text-gray-900">${escapeHtml(doc.title || doc.filename)}</h3>
                                    <p class="text-sm text-gray-500">${doc.filename} &bull; ${doc.page_count} pages</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="status-${doc.status} text-white text-xs px-2 py-1 rounded-full">${doc.status}</span>
                                <button onclick="viewDocument('${doc.id}')" class="p-2 text-gray-400 hover:text-blue-500" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="viewMarkdown('${doc.id}')" class="p-2 text-gray-400 hover:text-green-500" title="View Markdown">
                                    <i class="fab fa-markdown"></i>
                                </button>
                                <button onclick="confirmDelete('${doc.id}', '${escapeHtml(doc.title || doc.filename)}')" class="p-2 text-gray-400 hover:text-red-500" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                listEl.innerHTML = `
                    <div class="p-8 text-center text-red-500">
                        <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                        <p>Failed to load documents</p>
                    </div>
                `;
            }
        }

        // View document details
        async function viewDocument(id) {
            const modal = document.getElementById('document-modal');
            const content = document.getElementById('modal-content');
            const actions = document.getElementById('modal-actions');
            const title = document.getElementById('modal-title');

            title.textContent = 'Document Details';
            content.innerHTML = '<div class="flex justify-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i></div>';
            actions.innerHTML = '';
            modal.classList.remove('hidden');

            try {
                const res = await fetch(`${API_BASE}/documents/${id}`);
                const doc = await res.json();

                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Title</div>
                                <div class="font-medium">${escapeHtml(doc.title || '-')}</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Filename</div>
                                <div class="font-medium">${escapeHtml(doc.filename)}</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Status</div>
                                <div><span class="status-${doc.status} text-white text-xs px-2 py-1 rounded-full">${doc.status}</span></div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Pages</div>
                                <div class="font-medium">${doc.page_count}</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Chunks</div>
                                <div class="font-medium">${doc.chunk_count}</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Images</div>
                                <div class="font-medium">${doc.image_count}</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Extraction Method</div>
                                <div class="font-medium">${doc.extraction_method || '-'}</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="text-sm text-gray-500">Uploaded</div>
                                <div class="font-medium">${formatDate(doc.uploaded_at)}</div>
                            </div>
                        </div>
                        ${doc.error_message ? `
                            <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                                <div class="text-sm text-red-600 font-medium">Error</div>
                                <div class="text-red-800">${escapeHtml(doc.error_message)}</div>
                            </div>
                        ` : ''}
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="text-sm text-gray-500">Document ID</div>
                            <div class="font-mono text-sm">${doc.id}</div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <div class="text-sm text-gray-500">File Hash</div>
                            <div class="font-mono text-sm truncate">${doc.file_hash}</div>
                        </div>
                    </div>
                `;

                actions.innerHTML = `
                    <button onclick="viewMarkdown('${doc.id}')" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                        <i class="fab fa-markdown mr-2"></i>View Markdown
                    </button>
                    <button onclick="closeModal(); confirmDelete('${doc.id}', '${escapeHtml(doc.title || doc.filename)}')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                        <i class="fas fa-trash mr-2"></i>Delete
                    </button>
                `;
            } catch (e) {
                content.innerHTML = `<div class="text-center text-red-500 py-8">Failed to load document details</div>`;
            }
        }

        // View markdown
        async function viewMarkdown(id) {
            const modal = document.getElementById('document-modal');
            const content = document.getElementById('modal-content');
            const actions = document.getElementById('modal-actions');
            const title = document.getElementById('modal-title');

            title.textContent = 'Extracted Markdown';
            content.innerHTML = '<div class="flex justify-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i></div>';
            actions.innerHTML = '<button onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Close</button>';
            modal.classList.remove('hidden');

            try {
                const res = await fetch(`${API_BASE}/documents/${id}/markdown`);
                const data = await res.json();

                content.innerHTML = `
                    <div class="markdown-content rounded-lg p-4 text-sm overflow-x-auto max-h-[500px] overflow-y-auto">${escapeHtml(data.content)}</div>
                `;
            } catch (e) {
                content.innerHTML = `<div class="text-center text-red-500 py-8">Failed to load markdown</div>`;
            }
        }

        // Populate document dropdowns
        function populateDocumentDropdowns() {
            const options = documentsCache.map(doc =>
                `<option value="${doc.id}">${escapeHtml(doc.title || doc.filename)}</option>`
            ).join('');

            document.getElementById('chunk-document-filter').innerHTML =
                '<option value="">Select a document...</option>' + options;
            document.getElementById('image-document-filter').innerHTML =
                '<option value="">Select a document...</option>' + options;
        }

        // Load chunks for document
        async function loadChunksForDocument() {
            const docId = document.getElementById('chunk-document-filter').value;
            const listEl = document.getElementById('chunks-list');
            const countEl = document.getElementById('chunk-count');

            if (!docId) {
                listEl.innerHTML = `
                    <div class="p-8 text-center text-gray-500">
                        <i class="fas fa-puzzle-piece text-4xl mb-3"></i>
                        <p>Select a document to view its chunks</p>
                    </div>
                `;
                countEl.textContent = '';
                return;
            }

            listEl.innerHTML = '<div class="p-4"><div class="skeleton h-20 rounded"></div></div>'.repeat(3);

            try {
                const res = await fetch(`${API_BASE}/documents/${docId}/chunks`);
                const chunks = await res.json();
                countEl.textContent = `${chunks.length} chunks`;

                if (chunks.length === 0) {
                    listEl.innerHTML = '<div class="p-8 text-center text-gray-500">No chunks found</div>';
                    return;
                }

                listEl.innerHTML = chunks.map((chunk, i) => `
                    <div class="p-4 hover:bg-gray-50 fade-in">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-blue-100 rounded flex items-center justify-center text-sm font-medium text-blue-600">
                                ${chunk.chunk_index + 1}
                            </div>
                            <div class="flex-1 min-w-0">
                                ${chunk.section_h1 ? `<div class="text-sm font-medium text-gray-900">${escapeHtml(chunk.section_h1)}</div>` : ''}
                                ${chunk.section_h2 ? `<div class="text-xs text-gray-500">${escapeHtml(chunk.section_h2)}</div>` : ''}
                                <p class="text-sm text-gray-600 mt-1 line-clamp-3">${escapeHtml(chunk.text.substring(0, 300))}...</p>
                                <div class="flex items-center space-x-4 mt-2 text-xs text-gray-400">
                                    <span><i class="fas fa-file-alt mr-1"></i>Pages ${chunk.page_numbers.join(', ')}</span>
                                    <span><i class="fas fa-text-width mr-1"></i>${chunk.token_count} tokens</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                listEl.innerHTML = '<div class="p-8 text-center text-red-500">Failed to load chunks</div>';
            }
        }

        // Load images for document
        async function loadImagesForDocument() {
            const docId = document.getElementById('image-document-filter').value;
            const gridEl = document.getElementById('images-grid');

            if (!docId) {
                gridEl.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-images text-4xl mb-3"></i>
                        <p>Select a document to view its images</p>
                    </div>
                `;
                return;
            }

            gridEl.innerHTML = '<div class="grid grid-cols-4 gap-4">' +
                '<div class="skeleton h-32 rounded"></div>'.repeat(4) + '</div>';

            try {
                const res = await fetch(`${API_BASE}/documents/${docId}/images`);
                const images = await res.json();

                if (images.length === 0) {
                    gridEl.innerHTML = '<div class="text-center text-gray-500 py-8">No images found</div>';
                    return;
                }

                gridEl.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        ${images.map(img => `
                            <div class="bg-gray-100 rounded-lg overflow-hidden card-hover transition cursor-pointer" onclick="viewImage('${img.id}')">
                                <div class="aspect-square bg-gray-200 flex items-center justify-center">
                                    <img src="${API_BASE}/images/${img.id}/file" alt="Page ${img.page_number}" class="max-w-full max-h-full object-contain" onerror="this.parentElement.innerHTML='<i class=\\'fas fa-image text-gray-400 text-3xl\\'></i>'">
                                </div>
                                <div class="p-2">
                                    <div class="text-xs font-medium">Page ${img.page_number}</div>
                                    <div class="text-xs text-gray-500">${img.width}x${img.height}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (e) {
                gridEl.innerHTML = '<div class="text-center text-red-500 py-8">Failed to load images</div>';
            }
        }

        // View image
        function viewImage(id) {
            const modal = document.getElementById('document-modal');
            const content = document.getElementById('modal-content');
            const actions = document.getElementById('modal-actions');
            const title = document.getElementById('modal-title');

            title.textContent = 'Image Preview';
            content.innerHTML = `
                <div class="flex justify-center">
                    <img src="${API_BASE}/images/${id}/file" alt="Image" class="max-w-full max-h-[500px] object-contain rounded-lg">
                </div>
            `;
            actions.innerHTML = `
                <a href="${API_BASE}/images/${id}/file" download class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                    <i class="fas fa-download mr-2"></i>Download
                </a>
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900">Close</button>
            `;
            modal.classList.remove('hidden');
        }

        // Perform search
        async function performSearch() {
            const query = document.getElementById('search-query').value;
            const mode = document.getElementById('search-mode').value;
            const titleFilter = document.getElementById('search-title-filter').value;
            const limit = document.getElementById('search-limit').value;
            const resultsEl = document.getElementById('search-results');

            if (!query.trim()) {
                showToast('Please enter a search query', 'warning');
                return;
            }

            resultsEl.innerHTML = '<div class="bg-white rounded-lg p-4"><div class="skeleton h-24 rounded"></div></div>'.repeat(3);

            try {
                const res = await fetch(`${API_BASE}/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        mode: mode,
                        limit: parseInt(limit),
                        title_filter: titleFilter || null
                    })
                });
                const results = await res.json();

                if (results.length === 0) {
                    resultsEl.innerHTML = `
                        <div class="bg-white rounded-lg p-8 text-center text-gray-500">
                            <i class="fas fa-search text-4xl mb-3"></i>
                            <p>No results found</p>
                        </div>
                    `;
                    return;
                }

                resultsEl.innerHTML = results.map((r, i) => `
                    <div class="bg-white rounded-lg shadow-sm border p-4 fade-in">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <span class="text-sm font-medium text-blue-600">${escapeHtml(r.document_title)}</span>
                                ${r.section_h1 ? `<span class="text-gray-400 mx-2">&rsaquo;</span><span class="text-sm text-gray-600">${escapeHtml(r.section_h1)}</span>` : ''}
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs bg-gray-100 px-2 py-1 rounded">${r.search_mode}</span>
                                <span class="text-xs font-medium text-green-600">${(r.score * 100).toFixed(1)}%</span>
                            </div>
                        </div>
                        <p class="text-sm text-gray-700">${escapeHtml(r.text.substring(0, 400))}${r.text.length > 400 ? '...' : ''}</p>
                        <div class="mt-2 text-xs text-gray-400">
                            <span><i class="fas fa-file-alt mr-1"></i>Pages ${r.page_numbers.join(', ')}</span>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                resultsEl.innerHTML = '<div class="bg-white rounded-lg p-8 text-center text-red-500">Search failed</div>';
            }
        }

        // Delete document
        function confirmDelete(id, name) {
            const dialog = document.getElementById('confirm-dialog');
            document.getElementById('confirm-message').textContent = `Are you sure you want to delete "${name}"? This will remove all chunks, images, and markdown files.`;
            confirmCallback = async () => {
                try {
                    const res = await fetch(`${API_BASE}/documents/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        showToast('Document deleted successfully', 'success');
                        loadDocuments();
                        loadStats();
                    } else {
                        showToast('Failed to delete document', 'error');
                    }
                } catch (e) {
                    showToast('Delete failed: ' + e.message, 'error');
                }
                closeConfirm();
            };
            dialog.classList.remove('hidden');
        }

        function confirmAction() {
            if (confirmCallback) confirmCallback();
        }

        function closeConfirm() {
            document.getElementById('confirm-dialog').classList.add('hidden');
            confirmCallback = null;
        }

        // Modal functions
        function closeModal() {
            document.getElementById('document-modal').classList.add('hidden');
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msg = document.getElementById('toast-message');

            msg.textContent = message;
            icon.className = 'fas ' + {
                success: 'fa-check-circle text-green-400',
                error: 'fa-exclamation-circle text-red-400',
                warning: 'fa-exclamation-triangle text-yellow-400',
                info: 'fa-info-circle text-blue-400'
            }[type];

            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // Refresh all
        function refreshAll() {
            checkConnection();
            loadStats();
            loadDocuments();
            showToast('Refreshed', 'info');
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeConfirm();
            }
            if (e.key === 'Enter' && currentTab === 'search') {
                performSearch();
            }
        });

        // Close modals on backdrop click
        document.getElementById('document-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeModal();
        });
        document.getElementById('confirm-dialog').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeConfirm();
        });
    </script>
</body>
</html>
